The structure of this is just copied from Lukas Renggli's implementation for Grease.  